<!doctype html><html><head><title>Implementing a dynamic secret manager</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/olivier_hu0e6c1c8c6dc6b67478684e7b00b46b4a_53705_42x0_resize_q75_box.jpeg><meta property="og:title" content="Implementing a dynamic secret manager"><meta property="og:description" content="Deploying Hashicorp Vault"><meta property="og:type" content="article"><meta property="og:url" content="https://olivierlespagnon.com/posts/r%C3%A9alisations-techniques/hashicorp-vault/hashicorp_vault/"><meta property="article:published_time" content="2022-06-05T08:06:25+06:00"><meta property="article:modified_time" content="2022-06-05T08:06:25+06:00"><meta name=description content="Deploying Hashicorp Vault"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>Olivier Lespagnon</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=languageSelector role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span class="flag-icon flag-icon-gb"></span>English</a><div class=dropdown-menu aria-labelledby=languageSelector><a class="dropdown-item nav-link languages-item" href=/fr/posts/r%C3%A9alisations-techniques/hashicorp-vault/hashicorp_vault><span class="flag-icon flag-icon-fr"></span>FranÃ§ais</a></div></li></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/r%C3%A9alisations-techniques/>RÃ©alisations techniques</a><ul class=active><li><a href=/posts/r%C3%A9alisations-techniques/create-and-host-a-static-website-using-github-actions/github_website/ title="Create a static website">Create a static website</a></li><li><a href=/posts/r%C3%A9alisations-techniques/deploy-dependency-track/deploying-dependency-track/ title="Deploy Dependency Track">Deploy Dependency Track</a></li><li><a class=active href=/posts/r%C3%A9alisations-techniques/hashicorp-vault/hashicorp_vault/ title="Hashicorp Vault">Hashicorp Vault</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/soft-skills/>Soft skills</a><ul><li><a href=/posts/soft-skills/learn-a-new-job/learn_for_a_new_position/ title="How to train when taking on a new position">How to train when taking on a new position</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/tutorials/>Tutorials</a><ul><li><a href=/posts/tutorials/gathering-all-service-accounts-in-aws/gathering_svc_python/ title="Gathering service accounts">Gathering service accounts</a></li><li><a href=/posts/tutorials/introduction-to-kubernetes/get_started_with_k8s/ title="Intro to K8S">Intro to K8S</a></li><li><a href=/posts/tutorials/how-to-manage-your-infrastructure-using-terraform/terraform_infra/ title="Manage your infra with Terraform">Manage your infra with Terraform</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://olivierlespagnon.com/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/olivier_hu0e6c1c8c6dc6b67478684e7b00b46b4a_53705_120x120_fit_q75_box.jpeg alt="Author Image"><h5 class=author-name>Olivier Lespagnon</h5><p>June 5, 2022</p></div><div class=title><h1>Implementing a dynamic secret manager</h1></div><div class=post-content id=post-content><h2 id=can-you-pass-me-the-credentials-for-aws>&ldquo;Can you pass me the credentials for AWS?&rdquo;</h2><p>I arrived at LaJavaness in March as a Devops intern. It should be noted that I come from a specialized systems and networks training. So without cloud skills taught in class. But personally it&rsquo;s a domain that always attracted me and after having trained myself as much as possible, here I am in the middle of it.</p><p>LaJavaness is a company that produces AI solutions in the French way. And it has chosen the cloud as its infrastructure solution. This means that many accounts, and users cohabit on many cloud providers. And for each of these entities the permissions that go with it. A so-and-so must be able to access such-and-such a server, while another must not be able to.</p><p>All this creates a nice little mess as the company grows and new employees arrive. The life cycle of accesses and passwords must be managed properly. Restrict or extend rights as needed. And this for each person who has a need at any given time. It is a considerable workload that inevitably brings errors. But it only takes one mistake to compromise a critical resource.</p><h2 id=never-again>Never again!</h2><p>So naturally came my new project in the company. We need a way to manage all this in a reliable way while reducing the workload considerably. It&rsquo;s something that has a name in the IT world. It&rsquo;s called secret management.</p><p>Ideally, this would involve deploying a server that would act as the authority for assigning and managing accounts, credentials and tokens. Everyone who needs access to cloud resources should go to this server.</p><p>And that server is Vault! A product developed by Hashicorp.</p><p>The most obvious advantage is that our Vault will not forget to revoke the accesses requested for the customer database.</p><p>Another advantage is the possibility to automate certain actions. Thus increasing productivity.</p><blockquote><p>ðŸ’¡ <strong>Example</strong> : A developer would like to test his new machine learning algorithm. For that he needs a virtual machine able to execute the code. He puts his code online on the version manager, the latter then asks the Vault for credentials to deploy a virtual machine on a cloud. The Vault gives it to him, so the virtual machine is created. And the Vault removes the credentials. When the job is done, the Vault recreates the credentials, the manager shuts down the virtual machine. And that&rsquo;s it! Everything happened without the developer even having to ask IT to create a virtual machine, give it access rights, and then delete it.</p></blockquote><p>This is the &ldquo;magic&rdquo; that a secret manager allows.</p><h2 id=if-your-thing-crashes-the-whole-infrastructure-is-screwed-up->&ldquo;If your thing crashes, the whole infrastructure is screwed up&mldr; "</h2><p>When undertaking this project it is important to be aware of the risks involved.</p><p>As this server will be a central part of the infrastructure, it must be totally secure. A breach on it would potentially compromise the entire infrastructure as it is the one that assigns rights.</p><p>Furthermore, if all the teams adopt the Vault in their workflow, if it were to fall, all work would be interrupted.</p><p>I was reminded of this by a simple sentence during a meeting.</p><blockquote><p>If your server goes down, the whole infrastructure is down&mldr;
&ndash; My work-study teacher</p></blockquote><p>And finally, if I don&rsquo;t manage to make the project operational, I&rsquo;ll have a feeling of unfinished business and of not having been able to prove myself in this new company.</p><h2 id=in-plain-text>In plain text</h2><p>To summarize the project.</p><p>We need a Vault server that would be responsible for managing the secrets of our cloud infrastructures. Accessible by all by delegating the right rights. Which could interface with development / continuous integration workflows. The goal is to centralize the management of rights. The whole being resilient and available. It should not fall down or be compromised.</p><p>Now that we know what it is, we need to establish what needs to be done.</p><h2 id=the-recipe-please>The recipe please</h2><p>To install good secret management in a company you need:</p><ol><li>Deploy a Vault on a cloud in a secure way and test it</li><li>Establish consistent access control lists for users</li><li>Integrate the Vault with the Gitlab CI</li><li>Redeploy our entire data scientist infrastructure via Terraform and Vault</li></ol><h2 id=so-how-do-we-do-it>So how do we do it?</h2><p>As for any project, at the beginning you have to learn. And in my case that meant reading the Vault documentation and reading articles/guides on deploying the solution.</p><p>Once it&rsquo;s done, it&rsquo;s time to test it. I deployed a VM on the AWS cloud and got to work on it. So we install the software, configure it as we can and test it. I created a sub-account on AWS on which I will have to migrate all the Data infrastructure. By the way, I used it as a test environment for the Vault. I enter the credentials of this sub-account in Vault and I&rsquo;m ready to test. Well, almost. As for the infrastructure, in order not to waste time and to adopt common technologies I chose to use Terraform. It&rsquo;s an infrastructure as code tool. This means that I &ldquo;code&rdquo; the infrastructure and when I &ldquo;run&rdquo; the code it creates my infrastructure exactly as I want and always in the same way.</p><p>This solution allows me to interface Terraform with Vault. When Terraform runs, and as soon as it needs credentials to create resources on a cloud it will ask Vault to provide them.</p><p>So I was able to create the infrastructure templates that I would use to migrate the infrastructure data. And by using them I was able to test the access lists of my Vault. They are used to delimit who has the right to request creds on which accounts and on which clouds.</p><p>The next step is to integrate the Gitlab continuous integration pipeline with the Vault. The goal is that my infrastructure code is stored and versioned on it and that each time the code changes, it is replicated on the infrastructure. If I decide to remove a server, I just have to delete the lines of my code and the server will be removed from the cloud.</p><p>In practice, this consists of preparing a specific configuration file on Gitlab and providing access to the Vault.</p><p>The last step is the famous migration. Everything is still in progress but here is the game plan.</p><p>Each Data Scientist currently has his own infrastructure, be it X servers with a network or other. Using my template I can code all their needs and push the code on Gitlab. A &ldquo;worker&rdquo; starts and executes the code. It asks Vault for credentials and deploys all the requested infrastructure. And the best part is that it keeps the whole infrastructure in memory and replicates all future changes when I update the code.</p><h2 id=all-this-by-itself>All this by itself?</h2><p>In such a project, I was inevitably brought to collaborate with people from my company.</p><p>My work-study supervisor was the first person to identify the need. It is with him that we defined the objectives and controls to ensure that everything is finished.</p><p>Then, of course, I gave progress reports to my Devops colleagues during our weekly meetings. This is an opportunity to ask for advice on what&rsquo;s stuck or just to present the progress of the project and the direction we&rsquo;re going.</p><p>And finally, the IT and security manager of LaJavaness. It is him who created the accounts on the cloud and gave me the necessary identifiers.</p><h2 id=tadam>TADAM</h2><p>We are now at the end of the project. Where am I now? What is working? What doesn&rsquo;t work? You will have all the answers in the continuation of this part.</p><p>First of all the server is now installed in PROD mode.</p><p>It is responsible for all credentials on the Data account. And it works perfectly for the management of the lifespan of the latter.</p><p>Moreover it is almost integrated to the Gitlab CI via which I will manage their new infrastructure.</p><p>All that&rsquo;s left is to migrate everything when we&rsquo;re ready and sure that nothing will explode in our faces.</p><h2 id=the-future>The future</h2><p>Now that it&rsquo;s up and running, what&rsquo;s left to do? Well, start managing all the company&rsquo;s secrets through this channel. That each person needs to log in every day to ask for his or her credentials of the day. This will secure access to ALL company resources. If someone leaks their daily credentials, well, as the name implies, they will only be valid for that day. And if their Vault credentials are compromised, then we just need to cut off access to the Vault and all is safe.</p><p>The next step would be to integrate the different cloud providers of the company and all projects via the CI.</p></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/Olesp/olesp.github.io/edit/source/content/posts/R%c3%a9alisations%20techniques/Hashicorp%20Vault/hashicorp_vault.en.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/r%C3%A9alisations-techniques/deploy-dependency-track/deploying-dependency-track/ title="Deploy Dependency Track and monitor you apps" class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i>Prev</div><div class=next-prev-text>Deploy Dependency Track and monitor you apps</div></a></div><div class="col-md-6 next-article"><a href=/posts/soft-skills/learn-a-new-job/learn_for_a_new_position/ title="How to train when taking on a new position" class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>How to train when taking on a new position</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a><div class="dropdown languageSelector"><a class="btn dropdown-toggle" href=# id=languageSelector role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><img class=flag src=https://www.countryflags.io/gb/flat/16.png alt=gb>
English</a><div class=dropdown-menu aria-labelledby=languageSelector><a class="dropdown-item nav-link languages-item" href=/fr/posts/r%C3%A9alisations-techniques/hashicorp-vault/hashicorp_vault><img class=flag src=https://www.countryflags.io/fr/flat/24.png alt=fr>
FranÃ§ais</a></div></div></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#can-you-pass-me-the-credentials-for-aws>&ldquo;Can you pass me the credentials for AWS?&rdquo;</a></li><li><a href=#never-again>Never again!</a></li><li><a href=#if-your-thing-crashes-the-whole-infrastructure-is-screwed-up->&ldquo;If your thing crashes, the whole infrastructure is screwed up&mldr; "</a></li><li><a href=#in-plain-text>In plain text</a></li><li><a href=#the-recipe-please>The recipe please</a></li><li><a href=#so-how-do-we-do-it>So how do we do it?</a></li><li><a href=#all-this-by-itself>All this by itself?</a></li><li><a href=#tadam>TADAM</a></li><li><a href=#the-future>The future</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://olivierlespagnon.com/#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://olivierlespagnon.com/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://olivierlespagnon.com/#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=https://olivierlespagnon.com/#projects>Achievements</a></li><li class=nav-item><a class=smooth-scroll href=https://olivierlespagnon.com/#education>Education</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><span>Email:</span> <span>olespagnon@protonmail.com</span></li><li><span>Github:</span> <span>Olesp</span></li><li><span>Linkedin:</span> <span>olivierlespagnon</span></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">Â© 2021 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script><script type=text/javascript src=/js/popper.min.js></script><script type=text/javascript src=/js/bootstrap.min.js></script><script type=text/javascript src=/js/navbar.js></script><script type=text/javascript src=/js/plyr.js></script><script type=text/javascript src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>