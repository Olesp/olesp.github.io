<!doctype html><html><head><title>Impl√©mentation d'un gestionnaire de secrets dynamiques</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/olivier_hu0e6c1c8c6dc6b67478684e7b00b46b4a_53705_42x0_resize_q75_box.jpeg><meta property="og:title" content="Impl√©mentation d'un gestionnaire de secrets dynamiques"><meta property="og:description" content="Deploying Hashicorp Vault"><meta property="og:type" content="article"><meta property="og:url" content="https://olivierlespagnon.com/posts/r%C3%A9alisations-techniques/hashicorp-vault/hashicorp_vault/"><meta property="article:published_time" content="2022-06-05T08:06:25+06:00"><meta property="article:modified_time" content="2022-06-05T08:06:25+06:00"><meta name=description content="Deploying Hashicorp Vault"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>Olivier Lespagnon</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><a class=active href=/posts/hashicorp_vault/ title="Hashicorp Vault">Hashicorp Vault</a></li><li><a href=/posts/r%C3%A9alisations-techniques/ title="R√©alisations technique">R√©alisations technique</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://olivierlespagnon.com/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/olivier_hu0e6c1c8c6dc6b67478684e7b00b46b4a_53705_120x120_fit_q75_box.jpeg alt="Author Image"><h5 class=author-name>Olivier Lespagnon</h5><p>June 5, 2022</p></div><div class=title><h1>Impl√©mentation d'un gestionnaire de secrets dynamiques</h1></div><div class=post-content id=post-content><h2 id=tu-peux-me-passer-les-identifiants-pour-aws->&ldquo;Tu peux me passer les identifiants pour AWS ?&rdquo;</h2><p>Je suis arriv√© √† LaJavaness en mars en tant qu&rsquo;alternant Devops. Il faut savoir que je viens d&rsquo;une formation sp√©cialis√©e syst√®mes et r√©seaux. Donc sans comp√©tences cloud enseign√©es en cours. Mais personnellement c&rsquo;est un domaine qui m&rsquo;a toujours attir√© et apr√®s m&rsquo;√™tre autant que possible auto-form√© me voil√† en plein dedans.</p><p>LaJavaness est une entreprise qui produit des solutions IA √† la fran√ßaise. Et elle √† choisi comme solution d&rsquo;infrastructure le cloud. Ce qui veux dire que de nombreux comptes, et utilisateurs cohabitent sur de nombreux fournisseurs cloud. Et pour chacune de ces entit√©s les permissions qui vont avec. Un tel doit pouvoir acc√©der √† tel serveur tandis qu&rsquo;un autre ne doit surtout pas pouvoir.</p><p>Tout ceci cr√©er un joli petit bazar au fil de l&rsquo;√©volution de l&rsquo;entreprise et de l&rsquo;arriv√©e des nouveaux collaborateurs. Il faut g√©rer proprement la dur√©e de vie des acc√®s et des mots de passe. Restreindre ou √©tendre les droits en fonction des besoins. Et ce pour chacune des personnes qui √† un besoin √† un instant T. C&rsquo;est une charge de travail consid√©rable qui fatalement apporte des erreurs. Mais il suffis d&rsquo;une seule erreur pour compromettre une ressource critique.</p><h2 id=plus-jamais-√ßa->Plus jamais √ßa !</h2><p>Viens donc tout naturellement mon nouveau projet dans l&rsquo;entreprise. Il nous faudrait un moyen de g√©rer tout √ßa d&rsquo;une mani√®re fiable tout en r√©duisant consid√©rablement la charge de travail. C&rsquo;est quelque chose qui porte un nom dans le domaine IT. Cela s&rsquo;appelle la gestion des secrets.</p><p>Dans l&rsquo;id√©al il s&rsquo;agirait de d√©ployer un serveur qui ferait office d&rsquo;autorit√© en mati√®re d&rsquo;attribution et de gestions des comptes, identifiants et token. Chaque individu ayant besoin d&rsquo;acc√©der √† des ressources cloud devrait s&rsquo;adresser √† ce serveur.</p><p>Et ce serveur, c&rsquo;est Vault ! Un produit d√©velopp√© par Hashicorp.</p><p>L&rsquo;avantage le plus √©vident c&rsquo;est que notre Vault ne va pas oublier de r√©voquer les acc√®s demand√© pour la base de donn√©es clients.</p><p>Un autre avantage qui survient, c&rsquo;est la possibilit√© d&rsquo;automatiser certaines actions. Augmentant donc la productivit√©.</p><blockquote><p>üí° <strong>Exemple</strong> : Un d√©veloppeur voudrait tester son nouvel algorithme de machine learning. Pour cela il √† besoin d&rsquo;une machine virtuelle capable d&rsquo;ex√©cuter le code. Il met son code en ligne sur le gestionnaire de version, ce dernier demande alors au Vault des identifiants afin de d√©ployer une machine virtuelle sur un cloud. Le Vault lui donne, la machine virtuelle est donc cr√©√©e. Et le Vault supprime les identifiants. Quand le travail est fini, le Vault recr√©e des identifiants, le gestionnaire √©teins la machine virtuelle. Et voil√† ! Tout s&rsquo;est produit sans m√™me que le d√©veloppeur n&rsquo;ait eu besoin de demander au service IT de cr√©er une machine virtuelle, de lui donner les droits d&rsquo;acc√®s, puis de la supprimer ensuite.</p></blockquote><p>C&rsquo;est la &ldquo;magie&rdquo; que permet un gestionnaire de secrets.</p><h2 id=si-ton-truc-plante-cest-toute-linfra-qui-est-foutue->&ldquo;Si ton truc plante, c&rsquo;est toute l&rsquo;infra qui est foutue&mldr; "</h2><p>En entreprenant ce projet il est important de prendre conscience des risques qu&rsquo;il implique.</p><p>Comme ce serveur sera amen√© √† √™tre une pi√®ce centrale de l&rsquo;infrastructure il doit √™tre totalement s√©curis√©. Une faille dessus compromettrait potentiellement toute l&rsquo;infrastructure comme il est celui qui attribue les droits.</p><p>De plus si tout les √©quipes adoptent le Vault dans leur workflow, si ce dernier venait √† tomber tous les travaux seraient interrompus.</p><p>Chose qui m&rsquo;a √©t√© rappel√© par une simple phrase lors d&rsquo;une r√©union.</p><blockquote><p>Si ton serveur il tombe, c&rsquo;est toute l&rsquo;infra qui est down&mldr;
&ndash; Mon ma√Ætre d&rsquo;alternance</p></blockquote><p>Et pour finir, si je n&rsquo;arrive pas √† rendre le projet op√©rationnel, j&rsquo;aurais un sentiment d&rsquo;inachev√© et de ne pas avoir pu faire mes preuves dans cette nouvelle entreprise.</p><h2 id=en-clair-dans-le-texte>En clair dans le texte</h2><p>Pour r√©sumer le projet.</p><p>Il nous faut un serveur Vault qui serait responsable de g√©rer les secrets de nos infrastructures clouds. Accessible par tous en d√©l√©guant les droits qui vont bien. Qui pourrait s&rsquo;interfacer dans des workflows de d√©veloppement / int√©gration continue. Le but est de centraliser la gestions des droits. Le tout √©tant r√©siliant et disponible. Il ne faudrait pas qu&rsquo;il tombe ou qu&rsquo;il soit compromis.</p><p>Maintenant qu&rsquo;on sait ce que c&rsquo;est il faut √©tablir ce qui doit √™tre fait.</p><h2 id=la-recette-sil-vous-pla√Æt>La recette s&rsquo;il vous pla√Æt</h2><p>Pour installer une bonne gestion des secrets dans une entreprise il vous faut :</p><ol><li>D√©ployer un Vault sur un cloud de mani√®re s√©curis√© et le tester</li><li>√âtablir des liste de contr√¥le d&rsquo;acc√®s coh√©rente pour les utilisateurs</li><li>Int√©grer le Vault √† la CI de Gitlab</li><li>Red√©ployer toute l&rsquo;infrastructure de nos Data Scientists via Terraform et Vault</li></ol><h2 id=du-coup-comment-on-fait->Du coup, comment on fait ?</h2><p>Comme pour tout projet, au d√©but il faut apprendre. Et dans mon cas √ßa voulais dire aller lire la documentation de Vault et lire des articles / guides de d√©ploiements de la solution.</p><p>Une fois que c&rsquo;est fait c&rsquo;est l&rsquo;heure de tester tout √ßa. J&rsquo;ai d√©ploy√© une VM sur le cloud AWS et je m&rsquo;y suis coll√©. Donc on installe le logiciel, on le configure comme on peut et on teste. J&rsquo;ai cr√©e un sous compte sur AWS sur lequel devra migrer toute l&rsquo;infra des Data. Au passage il m&rsquo;a servi d&rsquo;environnement de test pour le Vault. Je rentre les credentials de ce sous compte dans Vault et je suis pr√™t √† tester. Enfin presque. Pour ce qui est de l&rsquo;infrastructure, afin de ne pas perdre de temps et d&rsquo;adopter des technos r√©pandues j&rsquo;ai choisis d&rsquo;utiliser Terraform. C&rsquo;est un outils d&rsquo;infrastructure as code. √áa veut dire que je &ldquo;code&rdquo; l&rsquo;infrastructure et quand je &ldquo;run&rdquo; le code cela cr√©er mon infra exactement comme je le souhaite et toujours de la m√™me mani√®re.</p><p>Cette solution me permet donc d&rsquo;interfacer Terraform avec Vault. Lorsque Terraform s&rsquo;execute, et d√®s qu&rsquo;il √† besoin de credentials pour cr√©er des ressources sur un cloud il demandera √† Vault de les lui fournir.</p><p>J&rsquo;ai donc pu cr√©er les templates d&rsquo;infrastructures que j&rsquo;utiliserais pour migrer l&rsquo;infra data. Et en les utilisant j&rsquo;ai pu √©prouver les listes d&rsquo;acc√®s de mon Vault. Elle servent √† d√©limiter qui a le droit de demander des creds sur quels comptes et sur quels clouds.</p><p>L&rsquo;√©tape suivant est d&rsquo;int√©grer la pipeline d&rsquo;int√©gration continue de Gitlab avec le Vault. Le but √©tant que mon code d&rsquo;infrastructure soit stock√© et versionn√© dessus et qu&rsquo;a chaque changement du code, ces derniers se r√©plique sur l&rsquo;infrastructure. Si je d√©cide de supprimer un serveur, j&rsquo;ai juste √† effacer les lignes de mon code et le serveur sera supprim√© du cloud.</p><p>En pratique cela consiste donc √† pr√©parer un fichier de configuration sp√©cifique sur Gitlab et lui fournir des acc√®s au Vault.</p><p>La derni√®re √©tape c&rsquo;est donc la fameuse migration. Tout est encore en cours mais voil√† le plan de jeu.</p><p>Chaque Data Scientist dispose actuellement de sa propre infra, que ce soit X serveurs avec un r√©seau ou autre. En utilisant mon template je peux coder tous leurs besoins et pousser le code sur Gitlab. Un &ldquo;worker&rdquo; se met en route et ex√©cute le code. Il demande les identifiants √† Vault et d√©ploie tout l&rsquo;infrastructure demand√©e. Et le plus beau c&rsquo;est qu&rsquo;il garde en m√©moire toute l&rsquo;infrastructure et r√©plique toutes les futures modifications lorsque je met √† jour le code.</p><h2 id=tout-√ßa-tout-seul->Tout √ßa tout seul ?</h2><p>Dans un tel projet, fatalement j&rsquo;ai √©t√© amen√© √† collaborer avec des personnes de mon entreprise.</p><p>Mon ma√Ætre d&rsquo;alternance est la premi√®re personne qui a caract√©ris√© le besoin. C&rsquo;est avec lui que nous avons d√©fini les objectifs et contr√¥les qui permettent de s&rsquo;assurer que tout est fini.</p><p>Ensuite j&rsquo;ai bien s√ªr fait des rapports d&rsquo;avancement √† mes coll√®gues Devops lors de nos r√©union hebdomadaires. C&rsquo;est l&rsquo;occasion de demander des conseils sur ce qui coince ou juste de pr√©senter l&rsquo;avancement du projet et la direction envisag√©e.</p><p>Et pour finir, le responsable informatique et s√©curit√© de LaJavaness. C&rsquo;est lui qui m&rsquo;a cr√©er les comptes sur le cloud et donn√©s les identifiants n√©cessaires.</p><h2 id=tadam>TADAM</h2><p>Nous voil√† d√©sormais au bout du projet. O√π est ce que j&rsquo;en suis rendu ? Qu&rsquo;est ce qui marche ? Qu&rsquo;est ce qui ne marche pas ? Vous aurez toutes les r√©ponses dans la suite de cette partie.</p><p>Premi√®rement le serveur est d√©sormais install√© en mode PROD.</p><p>Il est responsable de tous les credentials sur le compte des Data. Et il fonctionne parfaitement pour la gestion des dur√©e de vie de ces derniers.</p><p>De plus il est quasiment int√©gr√© √† la CI de Gitlab via laquelle je vais g√©rer leur nouvelle infra.</p><p>Il ne reste plus qu&rsquo;a migrer tout √ßa quand on sera pr√™t et s√ªr que rien ne nous explosera √† la figure.</p><h2 id=le-futur>Le futur</h2><p>Maintenant que c&rsquo;est en place et utilisable que reste-t-il √† faire ? Et bien commencer √† g√©rer tous les secrets de l&rsquo;entreprise via ce canal. Que chaque personne ait besoin de se connecter chaque jour dessus pour demander ses identifiants du jour. Cela permettra de s√©curiser les acc√®s √† TOUTES les ressources de l&rsquo;entreprise. Si jamais quelqu&rsquo;un fait fuiter ses identifiants journaliers et bien comme le nom l&rsquo;indique ils ne seront valable que la journ√©e m√™me. Et si ses identifiants du Vault sont compromis et bien il nous suffit de couper l&rsquo;acc√®s √† ce dernier et tout est sauf.</p><p>La suite serait d&rsquo;int√©grer les diff√©rents fournisseurs de cloud de l&rsquo;entreprises et tous les projets via la CI.</p></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/Olesp/olesp.github.io/edit/source/content/posts/R%c3%a9alisations%20techniques/Hashicorp%20Vault/hashicorp_vault.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>Improve this page</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#tu-peux-me-passer-les-identifiants-pour-aws->&ldquo;Tu peux me passer les identifiants pour AWS ?&rdquo;</a></li><li><a href=#plus-jamais-√ßa->Plus jamais √ßa !</a></li><li><a href=#si-ton-truc-plante-cest-toute-linfra-qui-est-foutue->&ldquo;Si ton truc plante, c&rsquo;est toute l&rsquo;infra qui est foutue&mldr; "</a></li><li><a href=#en-clair-dans-le-texte>En clair dans le texte</a></li><li><a href=#la-recette-sil-vous-pla√Æt>La recette s&rsquo;il vous pla√Æt</a></li><li><a href=#du-coup-comment-on-fait->Du coup, comment on fait ?</a></li><li><a href=#tout-√ßa-tout-seul->Tout √ßa tout seul ?</a></li><li><a href=#tadam>TADAM</a></li><li><a href=#le-futur>Le futur</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://olivierlespagnon.com/#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://olivierlespagnon.com/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://olivierlespagnon.com/#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=https://olivierlespagnon.com/#projects>Projects</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><span>Email:</span> <span>olespagnon@protonmail.com</span></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">¬© 2021 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script><script type=text/javascript src=/js/popper.min.js></script><script type=text/javascript src=/js/bootstrap.min.js></script><script type=text/javascript src=/js/navbar.js></script><script type=text/javascript src=/js/plyr.js></script><script type=text/javascript src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>